ğŸ”¥ **MENTOR NOTES â€” KUBERNETES MIGRATION DAY (Django E-commerce â†’ K8s)**
Author: Mohammed Sohail
Cluster: kubeadm (1 control-plane + workers)
CNI: Calico
Storage: local-path-provisioner
Status: ğŸš§ Media not served (expected) â†’ Fix tomorrow with NGINX Ingress

---

# ğŸ“Œ WHAT WE COMPLETED TODAY

---

# 1ï¸âƒ£ Docker â†’ Kubernetes Migration

You moved from:

EC2 + Docker Compose + Nginx
â¬‡
Kubernetes (kubeadm cluster)

This is a MAJOR step.

---

# 2ï¸âƒ£ Image Build & Registry

You:

âœ” Built image â†’ `sohail28/django-ecommerce:k8s-v8`
âœ” Pushed to Docker Hub
âœ” Updated deployment image
âœ” Rolling restart successful

This confirms:

* Image pipeline working
* Registry integration working
* Cluster pulling images correctly

---

# 3ï¸âƒ£ Namespace Setup

Created:

```
namespace: ecommerce
```

All workloads isolated properly.

Good production habit.

---

# 4ï¸âƒ£ Redis Deployment

âœ” Redis deployed
âœ” Running stable
âœ” Service working
âœ” Django connected via:

```
REDIS_URL=redis://redis:6379/0
```

Networking inside cluster works.

---

# 5ï¸âƒ£ PostgreSQL StatefulSet

âœ” Installed local-path storage
âœ” PVC created
âœ” StatefulSet running
âœ” Service working
âœ” DB connected via:

```
postgres://postgres:postgres@postgres:5432/django_ecommerce
```

Important learning:

* PVC Pending until StorageClass installed
* WaitForFirstConsumer behavior
* RWO limitations

Excellent debugging today.

---

# 6ï¸âƒ£ Django Deployment

Final working version:

```yaml
replicas: 1
```

Why 1?
Because:

```
ReadWriteOnce volume (RWO)
```

Cannot mount to multiple pods.

You correctly reduced replicas.

âœ” Resource limits added
âœ” Gunicorn running
âœ” collectstatic working
âœ” migrate running on startup
âœ” ClusterIP service working

---

# 7ï¸âƒ£ Media Storage (BIG LEARNING)

You:

âœ” Created `django-media-pvc`
âœ” Mounted at `/app/media`
âœ” Verified volume works
âœ” Verified file persistence
âœ” Created test.txt
âœ” Uploaded images

BUTâ€¦

---

# 8ï¸âƒ£ WHY MEDIA STILL NOT WORKING

Root cause:

```
Gunicorn does NOT serve media files.
```

Django `static()` helper works only with:

```
runserver
```

Not with:

```
gunicorn
```

So your request:

```
/media/products/2026/03/black.jpeg
```

Returns 404.

Because:

Gunicorn only serves WSGI app.
Not filesystem static content.

---

# ğŸ§  IMPORTANT ARCHITECTURE UNDERSTANDING

Right now:

User
â†“
Ingress
â†“
Django (Gunicorn)
â†“
Django app

There is NO static file server in front.

Production architecture requires:

User
â†“
Ingress (NGINX)
â†“
NGINX handles:
/static
/media
â†“
Proxy other requests to Django

This is how real production works.

---

# ğŸš§ CURRENT ISSUE SUMMARY

| Component    | Status           |
| ------------ | ---------------- |
| Django       | âœ… Working        |
| Redis        | âœ… Working        |
| Postgres     | âœ… Working        |
| PVC          | âœ… Bound          |
| Media Files  | âŒ Not served     |
| Static Files | âœ… via WhiteNoise |
| Ingress      | Installed        |
| ArgoCD       | Not yet          |

---

# ğŸ”¥ WHAT WE FIX TOMORROW

You chose:

> âœ… Use NGINX Ingress to serve /media

Good choice. Production mindset.

---

# ğŸš€ TOMORROW PLAN (CLEAR EXECUTION PATH)

---

## Step 1 â€” Modify Ingress

We will:

* Keep django service as backend
* Configure NGINX to serve `/media` from volume

But Ingress alone cannot access pod filesystem.

So we need:

---

## Step 2 â€” Proper Production Setup

Two options:

### Option A (Learning Mode â€“ Simple)

Run separate NGINX deployment:

* Mount same PVC
* Serve /media directly
* Proxy / to Django

### Option B (Cleaner Architecture)

Use:

* NGINX Ingress
* Django only app logic
* External object storage (S3)

Since you're learning Kubernetes infra:

We will do Option A.

---

# ğŸ“Œ WHAT WE WILL CREATE TOMORROW

1. nginx-deployment.yaml
2. nginx-service.yaml
3. Update ingress.yaml

NGINX config:

```
location /media/ {
    alias /app/media/;
}
location / {
    proxy_pass http://django;
}
```

---

# ğŸ§  CONCEPT YOU LEARNED TODAY (VERY IMPORTANT)

### 1ï¸âƒ£ RWO Volume Limitation

Scaling with file storage requires:

* RWX storage
* Or S3
* Or NFS
* Or separate file server

---

### 2ï¸âƒ£ Gunicorn vs Runserver

| Server    | Static | Media |
| --------- | ------ | ----- |
| runserver | Yes    | Yes   |
| gunicorn  | No     | No    |
| nginx     | Yes    | Yes   |

---

### 3ï¸âƒ£ Why Production Needs Reverse Proxy

App servers should NOT serve static files.

That is NGINX job.

---

### 4ï¸âƒ£ Pod OOM (Exit Code 137)

You experienced:

```
CrashLoopBackOff
```

Learned:

* Always set resource limits.

---

# ğŸ— CURRENT ARCHITECTURE

Cluster
â”‚
â”œâ”€â”€ Django Deployment (1 replica)
â”‚
â”œâ”€â”€ Postgres StatefulSet
â”‚
â”œâ”€â”€ Redis Deployment
â”‚
â”œâ”€â”€ Media PVC (local-path)
â”‚
â”œâ”€â”€ Ingress Controller (NGINX)
â”‚
â””â”€â”€ ClusterIP Services

This is already production-like architecture.

---

# ğŸ¯ TOMORROW OBJECTIVES

1ï¸âƒ£ Fix media with NGINX deployment
2ï¸âƒ£ Clean up Postgres extra PVC (postgres-pvc pending)
3ï¸âƒ£ Confirm domain routing works
4ï¸âƒ£ Make architecture production-grade
5ï¸âƒ£ Move to ArgoCD GitOps

---

# ğŸš€ AFTER MEDIA FIX

We move to:

### ArgoCD

Flow will become:

GitHub â†’ ArgoCD â†’ Cluster auto deploy

You push code â†’ cluster updates.

That is real DevOps.

---

# ğŸ† WHERE YOU STAND NOW

You are no longer learning Docker.

You are:

Building a real Kubernetes production stack.

Most beginners never reach this level.

---

# ğŸ“ TOMORROW START POINT

We start directly with:

ğŸ‘‰ Create NGINX deployment to serve media
ğŸ‘‰ Update ingress
ğŸ‘‰ Test with curl
ğŸ‘‰ Confirm browser loads images

Then:

ğŸ”¥ ArgoCD installation.

---

Rest now.

Tomorrow we complete infra layer.

Mentor proud today.
